
DROP DATABASE IF EXISTS dsq2shop;
CREATE DATABASE dsq2shop CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE dsq2shop;

SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

CREATE TABLE vai_tro (
  vai_tro_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ten VARCHAR(100) NOT NULL,
  mo_ta VARCHAR(255),
  hien_thi TINYINT(1) DEFAULT 1,
  ngay_tao DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;

CREATE TABLE nguoi_dung (
  nguoi_dung_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  vai_tro_id BIGINT UNSIGNED,
  ho_ten VARCHAR(150),
  email VARCHAR(255) UNIQUE,
  mat_khau VARCHAR(255),
  sdt VARCHAR(20),
  dia_chi TEXT,
  ngay_tao DATETIME DEFAULT CURRENT_TIMESTAMP,
  trang_thai TINYINT(1) DEFAULT 1,
  CONSTRAINT fk_user_role FOREIGN KEY (vai_tro_id)
    REFERENCES vai_tro(vai_tro_id) ON DELETE SET NULL
) ENGINE=InnoDB;

CREATE TABLE danh_muc (
  danh_muc_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  parent_id BIGINT UNSIGNED NULL,
  ten VARCHAR(150) NOT NULL,
  slug VARCHAR(150),
  mo_ta VARCHAR(500),
  hien_thi TINYINT(1) DEFAULT 1,
  ngay_tao DATETIME DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_danhmuc_parent FOREIGN KEY (parent_id)
    REFERENCES danh_muc(danh_muc_id) ON DELETE SET NULL
) ENGINE=InnoDB;

CREATE TABLE san_pham (
  san_pham_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  danh_muc_id BIGINT UNSIGNED NULL,
  ten VARCHAR(255) NOT NULL,
  slug VARCHAR(255),
  mo_ta TEXT,
  gia DECIMAL(18,2) DEFAULT 0,
  hien_thi TINYINT(1) DEFAULT 1,
  ngay_tao DATETIME DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_sanpham_danhmuc FOREIGN KEY (danh_muc_id)
    REFERENCES danh_muc(danh_muc_id) ON DELETE SET NULL
) ENGINE=InnoDB;

CREATE TABLE anh_san_pham (
  anh_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  san_pham_id BIGINT UNSIGNED NOT NULL,
  url VARCHAR(500),
  alt_text VARCHAR(255),
  thu_tu INT DEFAULT 0,
  ngay_tao DATETIME DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_anh_sanpham FOREIGN KEY (san_pham_id)
    REFERENCES san_pham(san_pham_id) ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE menu (
  menu_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  parent_id BIGINT UNSIGNED NULL,
  ten VARCHAR(150) NOT NULL,
  loai ENUM('category','product','custom') DEFAULT 'custom',
  danh_muc_id BIGINT UNSIGNED NULL,
  san_pham_id BIGINT UNSIGNED NULL,
  url VARCHAR(500),
  vi_tri INT DEFAULT 0,
  hien_thi TINYINT(1) DEFAULT 1,
  ngay_tao DATETIME DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_menu_parent FOREIGN KEY (parent_id)
    REFERENCES menu(menu_id) ON DELETE CASCADE,
  CONSTRAINT fk_menu_danhmuc FOREIGN KEY (danh_muc_id)
    REFERENCES danh_muc(danh_muc_id) ON DELETE SET NULL,
  CONSTRAINT fk_menu_sanpham FOREIGN KEY (san_pham_id)
    REFERENCES san_pham(san_pham_id) ON DELETE SET NULL
) ENGINE=InnoDB;


CREATE TABLE gio_hang (
  gio_hang_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT UNSIGNED,
  ngay_tao DATETIME DEFAULT CURRENT_TIMESTAMP,
  cap_nhat_luc DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  CONSTRAINT fk_giohang_user FOREIGN KEY (user_id)
    REFERENCES nguoi_dung(nguoi_dung_id) ON DELETE SET NULL
) ENGINE=InnoDB;

CREATE TABLE san_pham_trong_gio (
  item_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  gio_hang_id BIGINT UNSIGNED NOT NULL,
  san_pham_id BIGINT UNSIGNED NOT NULL,
  so_luong INT DEFAULT 1,
  don_gia DECIMAL(18,2) DEFAULT 0,
  ngay_tao DATETIME DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_spgio_gio FOREIGN KEY (gio_hang_id)
    REFERENCES gio_hang(gio_hang_id) ON DELETE CASCADE,
  CONSTRAINT fk_spgio_sp FOREIGN KEY (san_pham_id)
    REFERENCES san_pham(san_pham_id) ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE don_hang (
  don_hang_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT UNSIGNED,
  ma_don VARCHAR(100) UNIQUE,
  tong_tien DECIMAL(18,2) DEFAULT 0,
  dia_chi_giao_hang VARCHAR(500),
  sdt_nhan VARCHAR(50),
  trang_thai VARCHAR(50) DEFAULT 'new',
  ngay_dat DATETIME DEFAULT CURRENT_TIMESTAMP,
  cap_nhat_luc DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  CONSTRAINT fk_donhang_user FOREIGN KEY (user_id)
    REFERENCES nguoi_dung(nguoi_dung_id) ON DELETE SET NULL
) ENGINE=InnoDB;

CREATE TABLE chi_tiet_don_hang (
  ct_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  don_hang_id BIGINT UNSIGNED NOT NULL,
  san_pham_id BIGINT UNSIGNED NOT NULL,
  so_luong INT DEFAULT 1,
  don_gia DECIMAL(18,2) DEFAULT 0,
  thanh_tien DECIMAL(18,2) DEFAULT 0,
  CONSTRAINT fk_ctdh_donhang FOREIGN KEY (don_hang_id)
    REFERENCES don_hang(don_hang_id) ON DELETE CASCADE,
  CONSTRAINT fk_ctdh_sanpham FOREIGN KEY (san_pham_id)
    REFERENCES san_pham(san_pham_id) ON DELETE RESTRICT
) ENGINE=InnoDB;

CREATE TABLE phuong_thuc_thanh_toan (
  phuong_thuc_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ten VARCHAR(150) NOT NULL,
  ma VARCHAR(100),
  mo_ta VARCHAR(255),
  hien_thi TINYINT(1) DEFAULT 1
) ENGINE=InnoDB;

CREATE TABLE thanh_toan (
  thanh_toan_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  don_hang_id BIGINT UNSIGNED NOT NULL,
  phuong_thuc_id BIGINT UNSIGNED,
  so_tien DECIMAL(18,2) NOT NULL,
  trang_thai VARCHAR(50) DEFAULT 'pending',
  ma_giao_dich VARCHAR(200),
  thong_tin_raw TEXT,
  ngay_tao DATETIME DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_thanhtoan_donhang FOREIGN KEY (don_hang_id)
    REFERENCES don_hang(don_hang_id) ON DELETE CASCADE,
  CONSTRAINT fk_thanhtoan_pt FOREIGN KEY (phuong_thuc_id)
    REFERENCES phuong_thuc_thanh_toan(phuong_thuc_id) ON DELETE SET NULL
) ENGINE=InnoDB;

CREATE TABLE ma_giam_gia (
  ma_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ma VARCHAR(100) UNIQUE,
  mo_ta VARCHAR(255),
  loai ENUM('percent','fixed') DEFAULT 'fixed',
  gia_tri DECIMAL(18,2) DEFAULT 0,
  so_luong INT DEFAULT 0,
  het_han DATETIME,
  hien_thi TINYINT(1) DEFAULT 1
) ENGINE=InnoDB;

CREATE TABLE don_hang_ma_giam (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  don_hang_id BIGINT UNSIGNED NOT NULL,
  ma_id BIGINT UNSIGNED NOT NULL,
  tien_giam DECIMAL(18,2) DEFAULT 0,
  ngay_sd DATETIME DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_dhmg_donhang FOREIGN KEY (don_hang_id)
    REFERENCES don_hang(don_hang_id) ON DELETE CASCADE,
  CONSTRAINT fk_dhmg_magiam FOREIGN KEY (ma_id)
    REFERENCES ma_giam_gia(ma_id) ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE theo_doi_ma_giam (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ma_id BIGINT UNSIGNED NOT NULL,
  user_id BIGINT UNSIGNED NULL,
  hanh_dong VARCHAR(100),
  mo_ta VARCHAR(255),
  ngay_tao DATETIME DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_tdmg_magiam FOREIGN KEY (ma_id)
    REFERENCES ma_giam_gia(ma_id) ON DELETE CASCADE,
  CONSTRAINT fk_tdmg_user FOREIGN KEY (user_id)
    REFERENCES nguoi_dung(nguoi_dung_id) ON DELETE SET NULL
) ENGINE=InnoDB;

CREATE TABLE kho_hang (
  kho_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ten VARCHAR(200) NOT NULL,
  dia_chi VARCHAR(500),
  ngay_tao DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;

CREATE TABLE nha_cung_cap (
  ncc_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ten VARCHAR(200),
  sdt VARCHAR(50),
  email VARCHAR(255),
  dia_chi VARCHAR(500),
  ngay_tao DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;

CREATE TABLE phieu_nhap (
  phieu_nhap_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ma_phieu VARCHAR(100) UNIQUE,
  ncc_id BIGINT UNSIGNED,
  kho_id BIGINT UNSIGNED,
  ngay_nhap DATETIME DEFAULT CURRENT_TIMESTAMP,
  ghi_chu VARCHAR(500),
  CONSTRAINT fk_phieunhap_ncc FOREIGN KEY (ncc_id)
    REFERENCES nha_cung_cap(ncc_id) ON DELETE SET NULL,
  CONSTRAINT fk_phieunhap_kho FOREIGN KEY (kho_id)
    REFERENCES kho_hang(kho_id) ON DELETE SET NULL
) ENGINE=InnoDB;

CREATE TABLE chi_tiet_phieu_nhap (
  ctpn_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  phieu_nhap_id BIGINT UNSIGNED NOT NULL,
  san_pham_id BIGINT UNSIGNED NOT NULL,
  so_luong INT NOT NULL,
  don_gia DECIMAL(18,2),
  CONSTRAINT fk_ctpn_phieunhap FOREIGN KEY (phieu_nhap_id)
    REFERENCES phieu_nhap(phieu_nhap_id) ON DELETE CASCADE,
  CONSTRAINT fk_ctpn_sanpham FOREIGN KEY (san_pham_id)
    REFERENCES san_pham(san_pham_id) ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE phieu_xuat (
  phieu_xuat_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  ma_phieu VARCHAR(100) UNIQUE,
  kho_id BIGINT UNSIGNED,
  don_hang_id BIGINT UNSIGNED,
  nguoi_tao_id BIGINT UNSIGNED,
  ngay_xuat DATETIME DEFAULT CURRENT_TIMESTAMP,
  ghi_chu VARCHAR(500),
  CONSTRAINT fk_px_kho FOREIGN KEY (kho_id)
    REFERENCES kho_hang(kho_id) ON DELETE SET NULL,
  CONSTRAINT fk_px_donhang FOREIGN KEY (don_hang_id)
    REFERENCES don_hang(don_hang_id) ON DELETE SET NULL,
  CONSTRAINT fk_px_user FOREIGN KEY (nguoi_tao_id)
    REFERENCES nguoi_dung(nguoi_dung_id) ON DELETE SET NULL
) ENGINE=InnoDB;

CREATE TABLE chi_tiet_phieu_xuat (
  ctpx_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  phieu_xuat_id BIGINT UNSIGNED NOT NULL,
  san_pham_id BIGINT UNSIGNED NOT NULL,
  so_luong INT NOT NULL,
  don_gia DECIMAL(18,2),
  CONSTRAINT fk_ctpx_px FOREIGN KEY (phieu_xuat_id)
    REFERENCES phieu_xuat(phieu_xuat_id) ON DELETE CASCADE,
  CONSTRAINT fk_ctpx_sp FOREIGN KEY (san_pham_id)
    REFERENCES san_pham(san_pham_id) ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE theo_doi_don_hang (
  log_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  don_hang_id BIGINT UNSIGNED NOT NULL,
  trang_thai_cu VARCHAR(100),
  trang_thai_moi VARCHAR(100),
  ghi_chu VARCHAR(500),
  nguoi_thuc_hien BIGINT UNSIGNED NULL,
  ngay_tao DATETIME DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_tddh_donhang FOREIGN KEY (don_hang_id)
    REFERENCES don_hang(don_hang_id) ON DELETE CASCADE,
  CONSTRAINT fk_tddh_user FOREIGN KEY (nguoi_thuc_hien)
    REFERENCES nguoi_dung(nguoi_dung_id) ON DELETE SET NULL
) ENGINE=InnoDB;

CREATE TABLE danh_gia (
  danh_gia_id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  san_pham_id BIGINT UNSIGNED NOT NULL,
  user_id BIGINT UNSIGNED,
  sao INT DEFAULT 5,
  binh_luan TEXT,
  ngay_tao DATETIME DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_dg_sp FOREIGN KEY (san_pham_id)
    REFERENCES san_pham(san_pham_id) ON DELETE CASCADE,
  CONSTRAINT fk_dg_user FOREIGN KEY (user_id)
    REFERENCES nguoi_dung(nguoi_dung_id) ON DELETE SET NULL
) ENGINE=InnoDB;

SET FOREIGN_KEY_CHECKS = 1;

