-- Database AE SHOP
CREATE DATABASE IF NOT EXISTS ae_shop CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE ae_shop;

-- Bảng người dùng
CREATE TABLE nguoi_dung (
  id_nguoi_dung INT AUTO_INCREMENT PRIMARY KEY,
  ten VARCHAR(150) NOT NULL,
  email VARCHAR(200) NOT NULL UNIQUE,
  mat_khau VARCHAR(255) NOT NULL,
  dien_thoai VARCHAR(50),
  ngay_sinh DATE NULL,
  gioi_tinh VARCHAR(20),
  is_admin TINYINT(1) DEFAULT 0,
  trang_thai TINYINT(1) DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Bảng địa chỉ người dùng
CREATE TABLE dia_chi (
  id_dia_chi INT AUTO_INCREMENT PRIMARY KEY,
  id_nguoi_dung INT,
  ho_ten VARCHAR(150),
  so_dien_thoai VARCHAR(50),
  dia_chi_chi_tiet TEXT,
  phuong_xa VARCHAR(150),
  quan_huyen VARCHAR(150),
  tinh_thanh VARCHAR(150),
  mac_dinh TINYINT(1) DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (id_nguoi_dung) REFERENCES nguoi_dung(id_nguoi_dung) ON DELETE SET NULL
);

-- Danh mục / category
CREATE TABLE danh_muc (
  id_danh_muc INT AUTO_INCREMENT PRIMARY KEY,
  ten VARCHAR(150) NOT NULL,
  slug VARCHAR(200) NULL,
  mo_ta TEXT,
  trang_thai TINYINT(1) DEFAULT 1,
  thu_tu INT DEFAULT 0
);

-- Menu (nếu bạn cần menu động)
CREATE TABLE menu (
  id_menu INT AUTO_INCREMENT PRIMARY KEY,
  ten VARCHAR(150),
  duong_dan VARCHAR(255),
  vi_tri VARCHAR(50),
  id_danh_muc INT NULL,
  trang_thai TINYINT(1) DEFAULT 1,
  FOREIGN KEY (id_danh_muc) REFERENCES danh_muc(id_danh_muc) ON DELETE SET NULL
);

-- Nhà cung cấp
CREATE TABLE nha_cung_cap (
  id_ncc INT AUTO_INCREMENT PRIMARY KEY,
  ten VARCHAR(200) NOT NULL,
  dien_thoai VARCHAR(50),
  email VARCHAR(200),
  dia_chi TEXT,
  trang_thai TINYINT(1) DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Sản phẩm
CREATE TABLE san_pham (
  id_san_pham INT AUTO_INCREMENT PRIMARY KEY,
  ma_san_pham VARCHAR(100) UNIQUE,
  ten VARCHAR(255) NOT NULL,
  id_danh_muc INT,
  id_ncc INT NULL,
  mo_ta TEXT,
  gia DECIMAL(12,2) NOT NULL DEFAULT 0,
  gia_cu DECIMAL(12,2) DEFAULT NULL,
  so_luong INT DEFAULT 0,
  trang_thai TINYINT(1) DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (id_danh_muc) REFERENCES danh_muc(id_danh_muc) ON DELETE SET NULL,
  FOREIGN KEY (id_ncc) REFERENCES nha_cung_cap(id_ncc) ON DELETE SET NULL
);

-- Ảnh sản phẩm
CREATE TABLE anh_san_pham (
  id_anh INT AUTO_INCREMENT PRIMARY KEY,
  id_san_pham INT,
  duong_dan VARCHAR(255),
  la_anh_chinh TINYINT(1) DEFAULT 0,
  thu_tu INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (id_san_pham) REFERENCES san_pham(id_san_pham) ON DELETE CASCADE
);

-- Chi tiết sản phẩm (size, màu, chất liệu...)
CREATE TABLE chi_tiet_san_pham (
  id_chi_tiet INT AUTO_INCREMENT PRIMARY KEY,
  id_san_pham INT,
  sku VARCHAR(100) DEFAULT NULL,
  kich_thuoc VARCHAR(50) DEFAULT NULL,
  mau VARCHAR(100) DEFAULT NULL,
  chat_lieu VARCHAR(150) DEFAULT NULL,
  so_luong INT DEFAULT 0,
  gia DECIMAL(12,2) DEFAULT NULL,
  trang_thai TINYINT(1) DEFAULT 1,
  FOREIGN KEY (id_san_pham) REFERENCES san_pham(id_san_pham) ON DELETE CASCADE
);

-- Phiếu nhập (nhập hàng)
CREATE TABLE phieu_nhap (
  id_phieu_nhap INT AUTO_INCREMENT PRIMARY KEY,
  ma_phieu VARCHAR(100) UNIQUE,
  id_ncc INT,
  ngay_nhap DATE,
  tong_tien DECIMAL(14,2) DEFAULT 0,
  ghi_chu TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (id_ncc) REFERENCES nha_cung_cap(id_ncc) ON DELETE SET NULL
);

-- Chi tiết phiếu nhập (sản phẩm nhập)
CREATE TABLE chi_tiet_phieu_nhap (
  id_ctpn INT AUTO_INCREMENT PRIMARY KEY,
  id_phieu_nhap INT,
  id_san_pham INT,
  id_chi_tiet INT NULL,
  so_luong INT,
  gia_mua DECIMAL(12,2),
  FOREIGN KEY (id_phieu_nhap) REFERENCES phieu_nhap(id_phieu_nhap) ON DELETE CASCADE,
  FOREIGN KEY (id_san_pham) REFERENCES san_pham(id_san_pham) ON DELETE SET NULL,
  FOREIGN KEY (id_chi_tiet) REFERENCES chi_tiet_san_pham(id_chi_tiet) ON DELETE SET NULL
);

-- Mã giảm giá
CREATE TABLE ma_giam_gia (
  id_ma_giam_gia INT AUTO_INCREMENT PRIMARY KEY,
  ma VARCHAR(100) UNIQUE,
  loai VARCHAR(50) DEFAULT 'phan_tram',
  gia_tri DECIMAL(12,2) NOT NULL,
  so_luong INT DEFAULT 0,
  ap_dung_cho VARCHAR(50) DEFAULT 'toan_bo',
  id_doi_tuong INT DEFAULT NULL,
  ngay_bat_dau DATE,
  ngay_ket_thuc DATE,
  trang_thai TINYINT(1) DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Bảng theo dõi mã giảm giá (ai đã dùng)
CREATE TABLE theo_doi_ma_giam_gia (
  id INT AUTO_INCREMENT PRIMARY KEY,
  id_ma_giam_gia INT,
  id_nguoi_dung INT,
  ma_su_dung VARCHAR(100),
  ngay_su_dung TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  so_tien_giam DECIMAL(12,2) DEFAULT 0,
  FOREIGN KEY (id_ma_giam_gia) REFERENCES ma_giam_gia(id_ma_giam_gia) ON DELETE CASCADE,
  FOREIGN KEY (id_nguoi_dung) REFERENCES nguoi_dung(id_nguoi_dung) ON DELETE SET NULL
);

-- Đơn hàng
CREATE TABLE don_hang (
  id_don_hang INT AUTO_INCREMENT PRIMARY KEY,
  ma_don VARCHAR(100) UNIQUE,
  id_nguoi_dung INT,
  id_dia_chi INT,
  id_ma_giam_gia INT NULL,
  trang_thai VARCHAR(50) DEFAULT 'moi',
  tong_tien DECIMAL(14,2) DEFAULT 0,
  phi_van_chuyen DECIMAL(12,2) DEFAULT 0,
  ngay_dat DATETIME DEFAULT CURRENT_TIMESTAMP,
  ghi_chu TEXT,
  FOREIGN KEY (id_nguoi_dung) REFERENCES nguoi_dung(id_nguoi_dung) ON DELETE SET NULL,
  FOREIGN KEY (id_dia_chi) REFERENCES dia_chi(id_dia_chi) ON DELETE SET NULL,
  FOREIGN KEY (id_ma_giam_gia) REFERENCES ma_giam_gia(id_ma_giam_gia) ON DELETE SET NULL
);

-- Chi tiết đơn hàng
CREATE TABLE chi_tiet_don_hang (
  id_ctdh INT AUTO_INCREMENT PRIMARY KEY,
  id_don_hang INT,
  id_san_pham INT,
  id_chi_tiet INT NULL,
  so_luong INT,
  gia DECIMAL(12,2),
  thanh_tien DECIMAL(14,2),
  FOREIGN KEY (id_don_hang) REFERENCES don_hang(id_don_hang) ON DELETE CASCADE,
  FOREIGN KEY (id_san_pham) REFERENCES san_pham(id_san_pham) ON DELETE SET NULL,
  FOREIGN KEY (id_chi_tiet) REFERENCES chi_tiet_san_pham(id_chi_tiet) ON DELETE SET NULL
);

-- Phương thức thanh toán
CREATE TABLE phuong_thuc_thanh_toan (
  id_pttt INT AUTO_INCREMENT PRIMARY KEY,
  ten VARCHAR(150),
  mo_ta VARCHAR(255),
  trang_thai TINYINT(1) DEFAULT 1
);

-- Thanh toán (ghi nhận giao dịch)
CREATE TABLE thanh_toan (
  id_thanh_toan INT AUTO_INCREMENT PRIMARY KEY,
  id_don_hang INT,
  id_pttt INT,
  so_tien DECIMAL(14,2),
  trang_thai VARCHAR(50) DEFAULT 'cho_xu_ly',
  ngay_thanh_toan DATETIME DEFAULT CURRENT_TIMESTAMP,
  thong_tin_phu TEXT,
  FOREIGN KEY (id_don_hang) REFERENCES don_hang(id_don_hang) ON DELETE CASCADE,
  FOREIGN KEY (id_pttt) REFERENCES phuong_thuc_thanh_toan(id_pttt) ON DELETE SET NULL
);

-- Đánh giá sản phẩm
CREATE TABLE danh_gia (
  id_danh_gia INT AUTO_INCREMENT PRIMARY KEY,
  id_nguoi_dung INT,
  id_san_pham INT,
  sao TINYINT(1) DEFAULT 5,
  binh_luan TEXT,
  ngay_danh_gia TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  trang_thai TINYINT(1) DEFAULT 1,
  FOREIGN KEY (id_nguoi_dung) REFERENCES nguoi_dung(id_nguoi_dung) ON DELETE SET NULL,
  FOREIGN KEY (id_san_pham) REFERENCES san_pham(id_san_pham) ON DELETE CASCADE
);

-- Giỏ hàng tạm
CREATE TABLE gio_hang (
  id_gio_hang INT AUTO_INCREMENT PRIMARY KEY,
  id_nguoi_dung INT NULL,
  session_id VARCHAR(255) NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NULL,
  FOREIGN KEY (id_nguoi_dung) REFERENCES nguoi_dung(id_nguoi_dung) ON DELETE SET NULL
);

-- Sản phẩm trong giỏ hàng
CREATE TABLE san_pham_trong_gio_hang (
  id_item INT AUTO_INCREMENT PRIMARY KEY,
  id_gio_hang INT,
  id_san_pham INT,
  id_chi_tiet INT NULL,
  so_luong INT DEFAULT 1,
  gia DECIMAL(12,2),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (id_gio_hang) REFERENCES gio_hang(id_gio_hang) ON DELETE CASCADE,
  FOREIGN KEY (id_san_pham) REFERENCES san_pham(id_san_pham) ON DELETE SET NULL,
  FOREIGN KEY (id_chi_tiet) REFERENCES chi_tiet_san_pham(id_chi_tiet) ON DELETE SET NULL
);

-- Lịch sử đơn hàng
CREATE TABLE lich_su_don_hang (
  id_log INT AUTO_INCREMENT PRIMARY KEY,
  id_don_hang INT,
  trang_thai_cu VARCHAR(100),
  trang_thai_moi VARCHAR(100),
  ghi_chu TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (id_don_hang) REFERENCES don_hang(id_don_hang) ON DELETE CASCADE
);

-- Indexes
CREATE INDEX idx_sanpham_danhmuc ON san_pham(id_danh_muc);
CREATE INDEX idx_chitiet_sanpham_sku ON chi_tiet_san_pham(sku);
CREATE INDEX idx_donhang_user ON don_hang(id_nguoi_dung);

-- Một vài bản ghi demo
INSERT INTO danh_muc (ten, slug, mo_ta, trang_thai, thu_tu) VALUES
('Áo Khoác','ao-khoac','Danh mục áo khoác',1,1),
('Áo Thun','ao-thun','Danh mục áo thun',1,2),
('Quần Jeans','quan-jeans','Danh mục quần jeans',1,3);

INSERT INTO nha_cung_cap (ten, dien_thoai, email, dia_chi) VALUES
('NCC A','0123456789','nccA@example.com','Hà Nội'),
('NCC B','0987654321','nccB@example.com','TP HCM');

INSERT INTO san_pham (ma_san_pham, ten, id_danh_muc, id_ncc, mo_ta, gia, gia_cu, so_luong, trang_thai) VALUES
('AEJ001','Áo khoác kaki nam','1',1,'Áo khoác kaki form chuẩn',799000,999000,20,1),
('AET002','Áo phông cotton basic','2',2,'Áo phông 100% cotton',219000,259000,50,1),
('AEJ003','Quần jeans xanh','3',1,'Jeans nam co giãn',499000,NULL,30,1);

INSERT INTO anh_san_pham (id_san_pham, duong_dan, la_anh_chinh) VALUES
(1,'images/ao_khoac1.jpg',1),
(2,'images/ao_phong1.jpg',1),
(3,'images/quan_jeans1.jpg',1);

INSERT INTO phuong_thuc_thanh_toan (ten, mo_ta) VALUES ('Thanh toán khi nhận hàng','COD'),('Chuyển khoản ngân hàng','Bank transfer');

-- Tags demo
CREATE TABLE tags (id_tag INT AUTO_INCREMENT PRIMARY KEY, ten VARCHAR(150), slug VARCHAR(200));
CREATE TABLE san_pham_tag (id INT AUTO_INCREMENT PRIMARY KEY, id_san_pham INT, id_tag INT, FOREIGN KEY (id_san_pham) REFERENCES san_pham(id_san_pham) ON DELETE CASCADE, FOREIGN KEY (id_tag) REFERENCES tags(id_tag) ON DELETE CASCADE);
INSERT INTO tags (ten, slug) VALUES ('Thời trang nam','thoi-trang-nam'),('Hàng mới','hang-moi');
INSERT INTO san_pham_tag (id_san_pham, id_tag) VALUES (1,1),(2,1),(1,2);

-- Settings (site)
CREATE TABLE settings (`key` VARCHAR(100) PRIMARY KEY, `value` TEXT, updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP);
INSERT INTO settings (`key`, `value`) VALUES ('site_name','AE SHOP'), ('currency','VND'),('phone','0123456789'),('address','Hà Nội, VN');

-- Bảng bổ sung an toàn
CREATE TABLE roles (id_role INT AUTO_INCREMENT PRIMARY KEY, ten VARCHAR(100), mo_ta VARCHAR(255), created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP);
CREATE TABLE user_roles (id INT AUTO_INCREMENT PRIMARY KEY, id_nguoi_dung INT, id_role INT, FOREIGN KEY (id_nguoi_dung) REFERENCES nguoi_dung(id_nguoi_dung) ON DELETE CASCADE, FOREIGN KEY (id_role) REFERENCES roles(id_role) ON DELETE CASCADE);
INSERT INTO roles (ten, mo_ta) VALUES ('Super Admin','Toàn quyền'),('Admin','Quản lý sản phẩm và đơn hàng');

-- Bạn đã có dữ liệu demo cơ bản, kết thúc SQL.
